# SceneSolution 动画分类代码修改说明

## 一、修改目标

为 DETAILED 模式添加动画分类功能，将所有动画按照事件类型分类为4类：
- **PlaySkAnim_animations** - 骨骼动画
- **ChangeIdleAnim_animations** - 待机动画切换
- **ChangeWorkEvent_animations** - 工作动画切换
- **StopWorkEvent_animations** - 停止工作动画

## 二、动画Clip的来源框架

```
SceneSolution文件 (.scenesolution)
    │
    └─► SceneEditorResource
            │
            ├─► SceneDescriptor (场景描述符)
            │       │
            │       └─► NodeDescriptor[] (节点描述符数组)
            │               │
            │               ├─► SectionNode (Section类型节点)
            │               ├─► QuestNode (Quest类型节点)
            │               └─► 其他节点类型...
            │
            └─► SceneBackendData (后端数据)
                    │
                    └─► GraphDescriptor (图描述符)
                            │
                            └─► IterateNodes() (遍历所有场景图节点)
                                    │
                                    └─► SceneGraphNodeDescriptor[]
                                            │
                                            └─► GetEvents() (获取事件/Clip数组)
                                                    │
                                                    └─► EventDescriptor[] (动画Clip数组)
                                                            │
                                                            ├─► PlaySkAnimDescriptor (骨骼动画事件)
                                                            │       └─► m_animName
                                                            │
                                                            ├─► ChangeIdleAnimDescriptor (待机动画切换事件)
                                                            │       ├─► m_animName
                                                            │       ├─► m_idleAnimName
                                                            │       ├─► m_addIdleAnimName
                                                            │       └─► m_customTransitionAnim
                                                            │
                                                            ├─► ChangeWorkEvent (工作动画切换事件)
                                                            │       ├─► GetTransitionAnimInfo().m_animName
                                                            │       └─► GetGameplayAnimInfo().m_animName
                                                            │
                                                            └─► StopWorkEvent (停止工作事件)
                                                                    ├─► GetAnimationInfo().m_animName
                                                                    └─► GetGameplayAnimInfo().m_animName
```

## 三、代码修改的层次结构

### 第一层：数据收集层 (lines 700-706)

```cpp
// 全局HashMap声明 - 用于统计整个场景的动画使用情况
red::HashMap<CName, int> animNames;              // 所有动画（混合）
red::HashMap<CName, int> PlaySkAnimNames;        // 骨骼动画专用
red::HashMap<CName, int> ChangeIdleAnimNames;    // 待机动画专用
red::HashMap<CName, int> ChangeWorkAnimNames;    // 工作动画专用
red::HashMap<CName, int> StopWorkAnimNames;      // 停止工作动画专用
```

**位置**：`sceneSolutionResourceMetadataWriter.h` 第 700-704 行

**作用域优势**：这些全局level的HashMap与FULL模式中Section level的HashMap（lines 373-376）使用相同名称不冲突，因为它们在不同作用域。

### 第二层：图遍历层 (lines 709-794)

```cpp
sceneBackendData->m_graphDescriptor->IterateNodes([&](...) {
    // 遍历场景中的所有节点
    // 从每个节点获取其关联的事件(Clip)列表
    const red::DynArray<THandle<tools::EventDescriptor>>& events = node.GetEvents();

    // 对每个事件进行分类处理
    for (auto& event : events) {
        // 根据事件类型分别处理
    }
});
```

**功能**：通过 `IterateNodes()` 遍历场景图中的所有节点，从每个节点获取其关联的事件列表。

### 第三层：事件分类层 (lines 741-790)

#### 1. PlaySkAnimDescriptor（骨骼动画）- lines 741-746

```cpp
if ( event->IsA<tools::PlaySkAnimDescriptor>() )
{
    THandle<tools::PlaySkAnimDescriptor> skeletalAnimDescriptor = Cast<...>( event );
    AddAnimationToMap( animNames, skeletalAnimDescriptor->m_animName );
    AddAnimationToMap( PlaySkAnimNames, skeletalAnimDescriptor->m_animName );  // 分类
}
```

**数据来源**：
- `m_animName` - 动画名称字段

**说明**：这是最基础的骨骼动画Clip，只包含一个动画名称。

---

#### 2. ChangeIdleAnimDescriptor（待机动画切换）- lines 747-762

```cpp
else if ( event->IsA<tools::ChangeIdleAnimDescriptor>() )
{
    THandle<tools::ChangeIdleAnimDescriptor> changeIdleAnimDescriptor = Cast<...>( event );

    // 收集4个可能的动画名称
    AddAnimationToMap( animNames, changeIdleAnimDescriptor->m_animName );
    AddAnimationToMap( animNames, changeIdleAnimDescriptor->m_idleAnimName );
    AddAnimationToMap( animNames, changeIdleAnimDescriptor->m_addIdleAnimName );

    // 同时分类到ChangeIdleAnimNames
    AddAnimationToMap( ChangeIdleAnimNames, changeIdleAnimDescriptor->m_animName );
    AddAnimationToMap( ChangeIdleAnimNames, changeIdleAnimDescriptor->m_idleAnimName );
    AddAnimationToMap( ChangeIdleAnimNames, changeIdleAnimDescriptor->m_addIdleAnimName );

    // 可选的过渡动画
    if ( changeIdleAnimDescriptor->m_customTransitionAnim != CName::NONE() )
    {
        AddAnimationToMap( animNames, changeIdleAnimDescriptor->m_customTransitionAnim );
        AddAnimationToMap( ChangeIdleAnimNames, changeIdleAnimDescriptor->m_customTransitionAnim );
    }
}
```

**数据来源**：
- `m_animName` - 主动画名称
- `m_idleAnimName` - 待机动画名称
- `m_addIdleAnimName` - 附加待机动画名称
- `m_customTransitionAnim` - 自定义过渡动画（可选，需检查是否为NONE）

**说明**：待机动画切换事件，最多可包含4个动画字段。

---

#### 3. ChangeWorkEvent（工作动画切换）- lines 763-776

```cpp
else if ( event->IsA<scnb::events::ChangeWorkEvent>() )
{
    THandle<scnb::events::ChangeWorkEvent> changeWorkDescriptor = Cast<...>( event );

    // 过渡动画信息
    if ( changeWorkDescriptor->GetTransitionAnimInfo().m_animName != CName::NONE() )
    {
        AddAnimationToMap( animNames, changeWorkDescriptor->GetTransitionAnimInfo().m_animName );
        AddAnimationToMap( ChangeWorkAnimNames, changeWorkDescriptor->GetTransitionAnimInfo().m_animName );
    }

    // 游戏玩法动画信息
    if ( changeWorkDescriptor->GetGameplayAnimInfo().m_animName != CName::NONE() )
    {
        AddAnimationToMap( animNames, changeWorkDescriptor->GetGameplayAnimInfo().m_animName );
        AddAnimationToMap( ChangeWorkAnimNames, changeWorkDescriptor->GetGameplayAnimInfo().m_animName );
    }
}
```

**数据来源**：
- `GetTransitionAnimInfo().m_animName` - 过渡动画名称
- `GetGameplayAnimInfo().m_animName` - 游戏玩法动画名称

**说明**：工作动画切换事件，包含2个AnimInfo结构，需检查是否为NONE。

---

#### 4. StopWorkEvent（停止工作）- lines 777-790

```cpp
else if ( event->IsA<scnb::events::StopWorkEvent>() )
{
    THandle<scnb::events::StopWorkEvent> stopWorkDescriptor = Cast<...>( event );

    // 动画信息
    if ( stopWorkDescriptor->GetAnimationInfo().m_animName != CName::NONE() )
    {
        AddAnimationToMap( animNames, stopWorkDescriptor->GetAnimationInfo().m_animName );
        AddAnimationToMap( StopWorkAnimNames, stopWorkDescriptor->GetAnimationInfo().m_animName );
    }

    // 游戏玩法动画信息
    if ( stopWorkDescriptor->GetGameplayAnimInfo().m_animName != CName::NONE() )
    {
        AddAnimationToMap( animNames, stopWorkDescriptor->GetGameplayAnimInfo().m_animName );
        AddAnimationToMap( StopWorkAnimNames, stopWorkDescriptor->GetGameplayAnimInfo().m_animName );
    }
}
```

**数据来源**：
- `GetAnimationInfo().m_animName` - 基础动画名称
- `GetGameplayAnimInfo().m_animName` - 游戏玩法动画名称

**说明**：停止工作事件，包含2个AnimInfo结构，需检查是否为NONE。

---

### 第四层：数据输出层 (lines 885-928)

```cpp
// 1. 输出混合的动画列表（向后兼容）
writer.String( "animset_animations" );
writer.StartObject();
for ( const auto& animName : animNames )
{
    writer.String( animName.Key().AsChar() );
    writer.Int( animName.Value() );
}
writer.EndObject();

// 2. 输出分类后的动画列表
writer.String( "PlaySkAnim_animations" );
writer.StartObject();
for ( const auto& animName : PlaySkAnimNames )
{
    writer.String( animName.Key().AsChar() );
    writer.Int( animName.Value() );
}
writer.EndObject();

writer.String( "ChangeIdleAnim_animations" );
writer.StartObject();
for ( const auto& animName : ChangeIdleAnimNames )
{
    writer.String( animName.Key().AsChar() );
    writer.Int( animName.Value() );
}
writer.EndObject();

writer.String( "ChangeWorkEvent_animations" );
writer.StartObject();
for ( const auto& animName : ChangeWorkAnimNames )
{
    writer.String( animName.Key().AsChar() );
    writer.Int( animName.Value() );
}
writer.EndObject();

writer.String( "StopWorkEvent_animations" );
writer.StartObject();
for ( const auto& animName : StopWorkAnimNames )
{
    writer.String( animName.Key().AsChar() );
    writer.Int( animName.Value() );
}
writer.EndObject();
```

**输出格式**：JSON格式，每个字段包含动画名称及其使用次数的键值对。

## 四、数据流示意图

```
┌─────────────────────────────────────────────────────┐
│ SceneSolution文件加载                                │
└─────────────────┬───────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────┐
│ IterateNodes() 遍历所有场景图节点                    │
└─────────────────┬───────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────┐
│ 每个节点获取其Events数组 (Clip列表)                  │
└───┬─────────┬─────────┬─────────┬─────────┬─────────┘
    │         │         │         │         │
    ▼         ▼         ▼         ▼         ▼
  PlaySk  ChangeIdle ChangeWork StopWork  其他Clip
  AnimDesc AnimDesc   Event      Event     (忽略)
    │         │         │         │
    ▼         ▼         ▼         ▼
┌─────────────────────────────────────────────────────┐
│ 提取动画名称                                         │
│ • m_animName                                        │
│ • m_idleAnimName / m_addIdleAnimName               │
│ • TransitionAnimInfo / GameplayAnimInfo            │
└───┬─────────┬─────────┬─────────┬─────────────────┘
    │         │         │         │
    ▼         ▼         ▼         ▼
┌─────────────────────────────────────────────────────┐
│ 双重存储                                             │
│ 1. animNames (所有动画混合统计)                      │
│ 2. 分类HashMap (按事件类型分别统计)                  │
│    - PlaySkAnimNames                                │
│    - ChangeIdleAnimNames                            │
│    - ChangeWorkAnimNames                            │
│    - StopWorkAnimNames                              │
└─────────────────┬───────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────┐
│ JSON输出 (5个字段)                                   │
│ • animset_animations (混合)                         │
│ • PlaySkAnim_animations                             │
│ • ChangeIdleAnim_animations                         │
│ • ChangeWorkEvent_animations                        │
│ • StopWorkEvent_animations                          │
└─────────────────────────────────────────────────────┘
```

## 五、关键技术点

### 1. 动画Clip的本质

Clip就是 `EventDescriptor`，每个Clip代表时间轴上的一个事件，可能包含动画播放指令。

### 2. 双重统计机制

每个动画名称会被添加到两个地方：
- **animNames** - 用于输出所有动画的混合列表（保持向后兼容）
- **对应的分类HashMap** - 用于按类型分类输出

这样设计既保持了原有的 `animset_animations` 字段不变，又新增了分类字段。

### 3. 作用域优势

全局level的HashMap（lines 701-704）和FULL模式Section level的HashMap（lines 373-376）可以使用相同名称而不冲突，因为它们在不同作用域：
- **Section level** - 在 `for` 循环体内，每次循环都会创建新的局部变量
- **Global level** - 在函数作用域内，统计整个场景

### 4. 空值过滤

使用 `CName::NONE()` 检查，避免添加空动画名称：
```cpp
if ( descriptor->GetAnimInfo().m_animName != CName::NONE() )
{
    AddAnimationToMap( ... );
}
```

### 5. AddAnimationToMap 辅助函数

该函数负责：
- 检查动画名称是否为 `CName::NONE()`
- 如果HashMap中已存在该名称，增加计数
- 如果不存在，添加新条目并设置计数为1

## 六、使用方法

### 命令行

```bash
cmdlet.exe resourcesScan -sceneSolutions -quests -mode=detailedNodes -output=D:\Result\Empty_Questscenes.json -pretty -scanBasePath=base\quest\testgym
```

### 输出示例

```json
{
    "scene_solutions": {
        "base\\quest\\testgym\\meethanako.scenesolution": {
            "animset_animations": {
                "stand__2h_front__01": 4,
                "hanako__sit_barstool_bar_lean90__rh_on_bar_legs_crossed__01": 7,
                "johnny__stand_bar_lean0__2h_on_bar__01": 6,
                "None": 124,
                ...
            },
            "PlaySkAnim_animations": {
                "stand__2h_front__01": 2,
                "walk_0__to__stand__2h_front__01__turn0__01": 1,
                ...
            },
            "ChangeIdleAnim_animations": {
                "hanako__sit_barstool_bar_lean90__rh_on_bar_legs_crossed__01": 5,
                "johnny__stand_bar_lean0__2h_on_bar__01__shuffle__01": 1,
                ...
            },
            "ChangeWorkEvent_animations": {
                "sit_barstool_bar_lean270__lh_on_bar__02": 2,
                ...
            },
            "StopWorkEvent_animations": {
                "stand__2h_on_sides__01__bow__01": 1,
                ...
            }
        }
    }
}
```

## 七、文件修改清单

### 修改的文件
- `D:\AppSoft\Sy2077\2077\2077\CDPR2077\dev\src\backend\backendPipeline\src\sceneSolutionResourceMetadataWriter.h`

### 修改的行范围
1. **Lines 700-706** - 添加5个HashMap声明
2. **Line 745** - 修改PlaySkAnimDescriptor分支，添加分类收集
3. **Lines 753-760** - 修改ChangeIdleAnimDescriptor分支，添加分类收集
4. **Lines 769, 774** - 修改ChangeWorkEvent分支，添加分类收集
5. **Lines 783, 788** - 修改StopWorkEvent分支，添加分类收集
6. **Lines 894-928** - 添加4个分类字段的JSON输出代码

## 八、设计优势

1. **向后兼容** - 保留原有的 `animset_animations` 字段
2. **数据清晰** - 分类后便于分析每种事件类型的动画使用情况
3. **作用域隔离** - 全局和Section level使用相同变量名不冲突
4. **统一模式** - DETAILED模式和FULL模式使用相同的分类逻辑
5. **可扩展性** - 如需添加新的事件类型，只需添加新的分支和HashMap

---

**创建日期**：2026-01-12
**修改者**：Claude Code (Sonnet 4.5)
**相关Issue**：为DETAILED模式添加动画分类功能
